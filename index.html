<!DOCTYPE html>
<!-- <script type="module" crossorigin="anonymous" referrerpolicy="no-referrer">
    import { ethers } from "https://cdn.ethers.io/lib/ethers-5.2.esm.min.js";
    // Your code here...
</script> -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.6.9/ethers.umd.min.js" integrity="sha512-Veaz5IU2iRpa0BBrJlJeRgfJ7OAHWtVJZTXvgdH7s3ffsLUChllMCqC0Bb+eeRxGlrZ06iYIE/R3KsciCrgv3A==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script onload='LitJsSdk.litJsSdkLoadedInALIT()' src="https://jscdn.litgateway.com/index.web.js"></script>
<html>
    <head>
        <title>Lit Dappify Concept</title>
    </head>

    <body>
        <h1>Make a token gated widget</h1>
        <div id="walletconnect">
            <button id="button-connect">Connect Wallet</button>
        </div>
        <p>My first paragraph.</p>
        <div>
            <button id="button-lock">Lock</button>
        </div>
        <div id="placeholder-locked-content">
            <!-- filled with imperative functions -->
        </div>
    </body>
    <script type = "text/javascript">
        // utility functions
        /**
         * @param {String} HTML representing a single element
         * @return {Element}
         */
        function htmlToElement(html) {
            var template = document.createElement('template');
            html = html.trim(); // Never return a text node of whitespace as the result
            template.innerHTML = html;
            return template.content.firstChild;
        }
    </script>
    <script type = "text/javascript">
        // --- globals ---
        if (!window.ethereum) alert('Please install metamask');
        const provider = new ethers.providers.Web3Provider(window.ethereum);
        const signer = provider.getSigner();
        var chainIdToName = {'1': 'Ethereum'}

        // Lit
        const client = new LitJsSdk.LitNodeClient();

        // locked component
        var htmlLockedComponent = `<div class="locked-content-box" style="border:1px solid black;">
                    <div class="private-content-div">
                                <p id="private-content">This Text is going to be hidden and locked with on-chain condition.</p>
                            </div>
                    </div>`;
        
        var htmlPublicComponent = `<div class='public-content'> Your Wallet is not allowed to see this content. </div>`
        
        var componentToLock = htmlToElement(htmlLockedComponent);
        var componentForPublic = htmlToElement(htmlPublicComponent);
        
        document.getElementById('placeholder-locked-content').appendChild(componentToLock);

        // --- functions ---

        async function connectWithLitClient() {
            await client.connect();
        }

        function updateUIWithWallet(wallet) {
            var paragraph = document.createElement("paragraph");
            paragraph.id = wallet;
            paragraph.innerHTML = 'Connected Wallet: ' + wallet;
            var button = document.getElementById("button-connect");
            // document.getElementById('walletconnect').innerHTML = content;
            button.replaceWith(paragraph);
            // document.replaceChildren(["button-connect"])
            
        }

        async function connectWallet() {
        
            try {
                console.log(ethers);
                
                // ethereum object exists in window when metamask is installed, 
                // metamask injects an ethereum object (their api) into the window object
                
                const accounts = await provider.send("eth_requestAccounts", []);
                
                // via .requests() we are accessing the Ethereum RPC via the basic metamask api
                // const accounts = await ethereum.request({method: 'eth_accounts'});
                console.log(accounts);
        
                if (accounts.length){
                    const connectedWallet = accounts[0];
                    updateUIWithWallet(connectedWallet)
                } else{
                    console.log("No accounts found");
                }

            } catch (error) {
                console.log(error);
                throw new Error("No ethereum object");
            }
        }

        async function makeEncryption(params) {
            const address = signer.getAddress();
            const chainId = await signer.getChainId();
            const chain = chainIdToName[chainId];
            const messageToSign = "Hello";
            const signature = signer.signMessage(messageToSign);

            const authSig = {
                sig: signature,
                derivedVia: "web3.eth.personal.sign",
                signedMessage: messageToSign,
                address: address,
            };

            const accessControlConditionsNFT = [
                {
                contractAddress: '0xabdfb84dae7923dd346d5b1a0c6fbbb0e6e5df64',
                standardContractType: 'ERC721',
                chain,
                method: 'balanceOf',
                parameters: [
                    ':userAddress'
                    ],
                returnValueTest: {
                    comparator: '>',
                    value: '0'
                        }
                    }
            ]

            var privateContent = document.getElementById("private-content").innerHTML;

            const { encryptedString, symmetricKey } = await LitJsSdk.encryptString(privateContent)

            await connectWithLitClient();

            const encryptedSymmetricKey = await client.saveEncryptionKey({
            accessControlConditions: accessControlConditionsNFT,
            symmetricKey,
            authSig,
            chain,
            })

            encryptedSymmetricKey = LitJsSdk.uint8arrayToString(encryptedSymmetricKey, "base16")

            // get DOM element
            var privateContentBox = document.querySelector('.locked-content-box');
            // remove DOM element
            privateContentBox.removeChild();
            // add public component            
            document.getElementById('placeholder-locked-content').appendChild(componentForPublic);
            document.querySelector('.public-content').setAttribute('id', encryptedSymmetricKey)
            // instead, store it in html
            // make div with class="private-content-div" invisible
            // display encryptedString instead
            // assign encryptedSymmetricKey = LitJsSdk.uint8arrayToString(encryptedSymmetricKey, "base16")
            // call this function with a button

        }
    </script>
    <script type = "text/javascript">
        document.querySelector('#button-connect').addEventListener('click', connectWallet);
        document.querySelector('#button-lock').addEventListener('click', makeEncryption);
    </script>

    </html>
    